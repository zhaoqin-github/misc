#!/bin/bash

# Example: ./list_bigip.sh 10.250.11.150 | awk '{ print $8 }' | grep -v '^$' | grep -v mgmt | ./CVE-2020-5902-patch.sh

BIGIP_ADMIN_PASS=${BIGIP_ADMIN_PASS:-admin}
HTTPD_ALLOW=${HTTPD_ALLOW:-All}

while read MGMT_IP ; do
  echo "Apply patch to BIG-IP ${MGMT_IP}"
  # Patch the httpd configuration
  resp=$(curl -sku admin:${BIGIP_ADMIN_PASS} https://${MGMT_IP}/mgmt/tm/sys/httpd -H "Content-Type: application/json" -w "\n%{http_code}" -X PATCH -d \
  '{"include":"\nFileETag MTime Size\n\n# CVE-2020-5902\n<LocationMatch \\\";\\\">\nRedirect 404 /\n</LocationMatch>\n<LocationMatch \\\"hsqldb\\\">\nRedirect 404 /\n</LocationMatch>\n "}')
  code=$(echo "$resp" | tail -n1)
  if [[ $code -ne 200 ]] ; then
    echo >&2 "Fail to modify httpd include (HTTP: $code)"
    echo "$resp" | head -n-1 >&2
    continue
  fi

  ADDR_LIST=\"$(echo ${HTTPD_ALLOW} | sed "s/\ /\",\"/g")\"
  # Patch httpd source ip restriction
  resp=$(curl -sku admin:${BIGIP_ADMIN_PASS} https://${MGMT_IP}/mgmt/tm/sys/httpd -H "Content-Type: application/json" -w "\n%{http_code}" -X PATCH -d '{ "allow": [ '${ADDR_LIST}' ] }')
  code=$(echo "$resp" | tail -n1)
  if [[ $code -ne 200 ]] ; then
    echo >&2 "Fail to modify httpd allow (HTTP: $code)"
    echo "$resp" | head -n-1 >&2
    continue
  fi

  # Save the system config
  resp=$(curl -sku admin:${BIGIP_ADMIN_PASS} https://${MGMT_IP}/mgmt/tm/sys/config -H "Content-Type: application/json" -w "\n%{http_code}" -X POST -d '{"command":"save"}')
  code=$(echo "$resp" | tail -n1)
  if [[ $code -ne 200 ]] ; then
    echo >&2 "Fail to save httpd conf (HTTP: $code)"
    echo "$resp" | head -n-1 >&2
    continue
  fi

  echo "Verify patch on BIG-IP ${MGMT_IP}"
  # Verify the configuration
  curl -sku admin:${BIGIP_ADMIN_PASS} https://${MGMT_IP}/mgmt/tm/sys/httpd -H "Content-Type: application/json" -X GET | jq .

  echo 
done
